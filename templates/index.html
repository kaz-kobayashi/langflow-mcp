<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Agent</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/javascript.min.js"></script>

    <style>
        [x-cloak] { display: none !important; }

        .message-container {
            scroll-behavior: smooth;
        }

        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6B7280;
            animation: typing 1.4s infinite;
        }

        .typing-indicator:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Markdown styling */
        .markdown-content {
            line-height: 1.6;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4 {
            font-weight: bold;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .markdown-content h1 { font-size: 1.5em; }
        .markdown-content h2 { font-size: 1.3em; }
        .markdown-content h3 { font-size: 1.1em; }

        .markdown-content ul,
        .markdown-content ol {
            margin-left: 1.5em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }

        .markdown-content li {
            margin-bottom: 0.25em;
        }

        .markdown-content code {
            background-color: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875em;
        }

        .markdown-content pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }

        .markdown-content a {
            color: #2563eb;
            text-decoration: underline;
        }

        .markdown-content a:hover {
            color: #1d4ed8;
        }

        .markdown-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1em;
            margin-left: 0;
            color: #6b7280;
            font-style: italic;
        }

        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 0.5em 0;
        }

        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid #e5e7eb;
            padding: 0.5em;
            text-align: left;
        }

        .markdown-content table th {
            background-color: #f3f4f6;
            font-weight: bold;
        }

        /* Code block styling */
        .hljs {
            border-radius: 0.5rem;
            font-size: 0.875em;
        }

        /* User message styling (white text on blue background) */
        .user-message .markdown-content a {
            color: #bfdbfe;
            text-decoration: underline;
        }

        .user-message .markdown-content a:hover {
            color: #dbeafe;
        }

        .user-message .markdown-content code {
            background-color: rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }

        .user-message .markdown-content pre {
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* JSON collapsible styling */
        .json-collapsible {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin: 0.5em 0;
            overflow: hidden;
        }

        .json-collapsible-header {
            background-color: #f3f4f6;
            padding: 0.5rem 1rem;
            cursor: pointer;
            user-select: none;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .json-collapsible-header:hover {
            background-color: #e5e7eb;
        }

        .json-collapsible-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .json-toggle-icon {
            transition: transform 0.2s;
        }

        .json-toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 900px;
            max-height: 90vh;
            width: 90%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            ring: 2px;
            ring-color: rgba(59, 130, 246, 0.5);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        .param-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .param-table th,
        .param-table td {
            padding: 0.5rem;
            text-align: left;
            border: 1px solid #e5e7eb;
        }

        .param-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }

        .param-table input {
            width: 100%;
            padding: 0.375rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
        }

        .param-table input:focus {
            outline: none;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50" x-data="chatApp()" x-init="init()">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">ğŸ¤– AI Chat Agent</h1>
                    <p class="text-sm text-gray-200 mt-1">Powered by LLM</p>
                </div>
                <button
                    x-show="!skipAuth"
                    @click="logout()"
                    class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium transition-colors"
                >
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </header>

        <!-- Main Chat Container -->
        <main class="flex-1 container mx-auto px-4 py-6 max-w-4xl">
            <!-- Messages Container -->
            <div
                class="message-container bg-white rounded-lg shadow-md p-6 mb-4 h-[calc(100vh-300px)] overflow-y-auto"
                x-ref="messageContainer"
            >
                <template x-if="messages.length === 0">
                    <div class="text-center text-gray-400 mt-20">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                        </svg>
                        <p class="text-lg">ä¼šè©±ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</p>
                    </div>
                </template>

                <template x-for="(message, index) in messages" :key="index">
                    <div
                        class="mb-4 flex"
                        :class="message.role === 'user' ? 'justify-end' : 'justify-start'"
                    >
                        <div
                            class="max-w-[75%] rounded-lg px-4 py-3"
                            :class="message.role === 'user'
                                ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white user-message'
                                : 'bg-gray-100 text-gray-800'"
                        >
                            <div class="flex items-start gap-2">
                                <span class="text-lg" x-text="message.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'"></span>
                                <div class="flex-1 markdown-content text-sm" x-html="formatMessage(message.content)"></div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Typing Indicator -->
                <template x-if="isLoading">
                    <div class="mb-4 flex justify-start">
                        <div class="max-w-[75%] rounded-lg px-4 py-3 bg-gray-100">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">ğŸ¤–</span>
                                <div class="flex gap-1">
                                    <span class="typing-indicator"></span>
                                    <span class="typing-indicator"></span>
                                    <span class="typing-indicator"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Quick Access Buttons -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-semibold text-gray-700">ğŸš€ æ©Ÿèƒ½é¸æŠ</h3>
                </div>

                <!-- Guided Form Button (Primary) -->
                <button
                    @click="openGuidedForm()"
                    class="w-full mb-3 px-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-lg text-sm font-semibold transition-all shadow-md hover:shadow-lg"
                >
                    âœ¨ æ©Ÿèƒ½ã‚’é¸ã‚“ã§å…¥åŠ›ã™ã‚‹ï¼ˆãŠã™ã™ã‚ï¼‰
                </button>

                <!-- Quick Access Buttons -->
                <div class="text-xs text-gray-500 mb-2 font-medium">ã‚ˆãä½¿ã†æ©Ÿèƒ½ï¼š</div>
                <div class="flex flex-wrap gap-2">
                    <button
                        @click="openSupplyChainForm()"
                        class="px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg text-xs font-medium transition-colors border border-blue-200"
                    >
                        ğŸ­ ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³æœ€é©åŒ–
                    </button>
                    <button
                        @click="openQuickForm('eoq')"
                        class="px-3 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg text-xs font-medium transition-colors border border-green-200"
                    >
                        ğŸ“¦ EOQè¨ˆç®—
                    </button>
                    <button
                        @click="openQuickForm('demand_forecast')"
                        class="px-3 py-2 bg-amber-50 hover:bg-amber-100 text-amber-700 rounded-lg text-xs font-medium transition-colors border border-amber-200"
                    >
                        ğŸ“ˆ éœ€è¦äºˆæ¸¬
                    </button>
                    <button
                        @click="openQuickForm('safety_stock')"
                        class="px-3 py-2 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg text-xs font-medium transition-colors border border-purple-200"
                    >
                        ğŸ›¡ï¸ å®‰å…¨åœ¨åº«è¨ˆç®—
                    </button>
                    <button
                        @click="openExcelMESSAModal()"
                        class="px-3 py-2 bg-orange-50 hover:bg-orange-100 text-orange-700 rounded-lg text-xs font-medium transition-colors border border-orange-200"
                    >
                        ğŸ“Š Excelã§å®‰å…¨åœ¨åº«æœ€é©åŒ–
                    </button>
                    <button
                        @click="openTableMESSAModal()"
                        class="px-3 py-2 bg-teal-50 hover:bg-teal-100 text-teal-700 rounded-lg text-xs font-medium transition-colors border border-teal-200"
                    >
                        ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«ã§å®‰å…¨åœ¨åº«æœ€é©åŒ–
                    </button>
                </div>
            </div>

            <!-- Input Area -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <form @submit.prevent="sendMessage()" class="flex gap-3">
                    <input
                        type="text"
                        x-model="userInput"
                        :disabled="isLoading"
                        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
                        autocomplete="off"
                    />
                    <button
                        type="submit"
                        :disabled="isLoading || !userInput.trim()"
                        class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-semibold hover:from-blue-600 hover:to-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                    >
                        <span x-show="!isLoading">é€ä¿¡</span>
                        <span x-show="isLoading">é€ä¿¡ä¸­...</span>
                    </button>
                </form>

                <!-- Auto Detection Mode Toggle -->
                <div class="mt-3 flex items-center justify-between">
                    <label class="flex items-center gap-2 text-sm cursor-pointer">
                        <input
                            type="checkbox"
                            x-model="autoDetectMode"
                            class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                        />
                        <span class="text-gray-700">
                            ğŸ¯ è‡ªå‹•ãƒ„ãƒ¼ãƒ«æ¤œå‡ºãƒ¢ãƒ¼ãƒ‰
                            <span class="text-xs text-gray-500">(ãƒ„ãƒ¼ãƒ«è‡ªå‹•é¸æŠ&ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèª)</span>
                        </span>
                    </label>

                    <!-- Clear Chat Button -->
                    <button
                        @click="clearChat()"
                        class="text-sm text-gray-500 hover:text-gray-700 underline"
                        x-show="messages.length > 0"
                    >
                        ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t py-4">
            <div class="container mx-auto px-4 text-center text-sm text-gray-600">
                <p>AI Chat Agent - FastAPI + Alpine.js + Tailwind CSS</p>
            </div>
        </footer>
    </div>

    <!-- Guided Form Modal -->
    <div x-show="showGuidedModal" x-cloak class="modal-overlay" @click.self="closeGuidedForm()">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">âœ¨ æ©Ÿèƒ½ã‚’é¸ã‚“ã§å…¥åŠ›</h2>
                    <div class="text-sm text-gray-500 mt-1">
                        <span x-show="guidedForm.step === 1">ã‚¹ãƒ†ãƒƒãƒ— 1/3: ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠ</span>
                        <span x-show="guidedForm.step === 2">ã‚¹ãƒ†ãƒƒãƒ— 2/3: æ©Ÿèƒ½ã‚’é¸æŠ</span>
                        <span x-show="guidedForm.step === 3">ã‚¹ãƒ†ãƒƒãƒ— 3/3: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å…¥åŠ›</span>
                    </div>
                </div>
                <button @click="closeGuidedForm()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <!-- Step 1: Category Selection -->
                <div x-show="guidedForm.step === 1" class="space-y-3">
                    <p class="text-sm text-gray-600 mb-4">å®Ÿè¡Œã—ãŸã„æ©Ÿèƒ½ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„ï¼š</p>
                    <template x-for="category in functionCategories" :key="category.id">
                        <button
                            @click="selectCategory(category)"
                            class="w-full p-4 text-left border-2 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-all"
                            :class="guidedForm.selectedCategory?.id === category.id ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'"
                        >
                            <div class="flex items-start gap-3">
                                <span class="text-3xl" x-text="category.icon"></span>
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800" x-text="category.name"></div>
                                    <div class="text-sm text-gray-600 mt-1" x-text="category.description"></div>
                                </div>
                            </div>
                        </button>
                    </template>
                </div>

                <!-- Step 2: Function Selection -->
                <div x-show="guidedForm.step === 2" class="space-y-3">
                    <button @click="guidedForm.step = 1" class="text-sm text-indigo-600 hover:text-indigo-700 mb-3">
                        â† ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠã«æˆ»ã‚‹
                    </button>
                    <p class="text-sm text-gray-600 mb-4">å®Ÿè¡Œã—ãŸã„æ©Ÿèƒ½ã‚’é¸ã‚“ã§ãã ã•ã„ï¼š</p>
                    <template x-for="func in (guidedForm.selectedCategory?.functions || [])" :key="func.id">
                        <button
                            @click="selectFunction(func)"
                            class="w-full p-4 text-left border-2 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-all"
                            :class="guidedForm.selectedFunction?.id === func.id ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'"
                        >
                            <div class="flex items-center gap-3">
                                <span class="text-2xl" x-text="func.icon"></span>
                                <span class="font-medium text-gray-800" x-text="func.name"></span>
                            </div>
                        </button>
                    </template>
                </div>

                <!-- Step 3: Parameter Input (Dynamic Form) -->
                <div x-show="guidedForm.step === 3">
                    <button @click="guidedForm.step = 2" class="text-sm text-indigo-600 hover:text-indigo-700 mb-3">
                        â† æ©Ÿèƒ½é¸æŠã«æˆ»ã‚‹
                    </button>
                    <div x-show="guidedForm.selectedFunction" class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start gap-2">
                            <span class="text-2xl" x-text="guidedForm.selectedFunction?.icon"></span>
                            <div>
                                <div class="font-semibold text-gray-800" x-text="functionTemplates[guidedForm.selectedFunction?.id]?.name"></div>
                                <div class="text-sm text-gray-600 mt-1" x-text="functionTemplates[guidedForm.selectedFunction?.id]?.description"></div>
                            </div>
                        </div>
                    </div>
                    <div id="dynamicFormFields" class="space-y-4">
                        <!-- Dynamic fields will be inserted here -->
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button
                    @click="closeGuidedForm()"
                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors"
                >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button
                    x-show="guidedForm.step === 3"
                    @click="submitGuidedForm()"
                    class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors"
                >
                    å®Ÿè¡Œã™ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- Supply Chain Simulation Modal -->
    <div x-show="showSupplyChainModal" x-cloak class="modal-overlay" @click.self="closeSupplyChainForm()">
        <div class="modal-content" @click.away="closeSupplyChainForm()">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-800">ğŸ­ ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
                <button @click="closeSupplyChainForm()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <!-- Basic Parameters -->
                <h3 class="text-lg font-semibold text-gray-800 mb-3">åŸºæœ¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">ã‚µãƒ³ãƒ—ãƒ«æ•°</label>
                        <input type="number" x-model.number="scForm.numSamples" class="form-input" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“</label>
                        <input type="number" x-model.number="scForm.periods" class="form-input" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ®µéšæ•°</label>
                        <input type="number" x-model.number="scForm.numStages" class="form-input" min="1" @change="updateStageData()">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">å¹³å‡éœ€è¦ï¼ˆå€‹/æ—¥ï¼‰</label>
                        <input type="number" x-model.number="scForm.meanDemand" class="form-input" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¨™æº–åå·®ï¼ˆå€‹/æ—¥ï¼‰</label>
                        <input type="number" x-model.number="scForm.stdDemand" class="form-input" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ãƒãƒƒã‚¯ã‚ªãƒ¼ãƒ€ãƒ¼ã‚³ã‚¹ãƒˆï¼ˆå††/å€‹ï¼‰</label>
                        <input type="number" x-model.number="scForm.backorderCost" class="form-input" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å›ºå®šç™ºæ³¨ã‚³ã‚¹ãƒˆï¼ˆå††ï¼‰</label>
                        <input type="number" x-model.number="scForm.fixedOrderCost" class="form-input" step="0.1">
                    </div>
                </div>

                <!-- Stage-specific Parameters Table -->
                <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-3">æ®µéšåˆ¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h3>
                <div class="table-container">
                    <table class="param-table">
                        <thead>
                            <tr>
                                <th>æ®µéš</th>
                                <th>ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ï¼ˆæ—¥ï¼‰</th>
                                <th>ç™ºæ³¨ç‚¹ sï¼ˆå€‹ï¼‰</th>
                                <th>åŸºåœ¨åº«ãƒ¬ãƒ™ãƒ« Sï¼ˆå€‹ï¼‰</th>
                                <th>åœ¨åº«ä¿ç®¡è²»ç”¨ hï¼ˆå††/å€‹/æ—¥ï¼‰</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(stage, index) in scForm.stages" :key="index">
                                <tr>
                                    <td x-text="'Stage ' + index"></td>
                                    <td><input type="number" x-model.number="stage.leadTime" min="0"></td>
                                    <td><input type="number" x-model.number="stage.reorderPoint" min="0"></td>
                                    <td><input type="number" x-model.number="stage.baseStockLevel" min="0"></td>
                                    <td><input type="number" x-model.number="stage.holdingCost" min="0" step="0.1"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button
                    @click="closeSupplyChainForm()"
                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors"
                >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button
                    @click="submitSupplyChainForm()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
                >
                    ãƒãƒ£ãƒƒãƒˆã«é€ä¿¡
                </button>
            </div>
        </div>
    </div>

    <!-- Parameter Confirmation Modal -->
    <div x-show="showParameterConfirmModal" x-cloak class="modal-overlay" @click.self="closeParameterConfirmModal()">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">ğŸ¯ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèª</h2>
                    <div class="text-sm text-gray-500 mt-1">
                        æŠ½å‡ºã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„
                    </div>
                </div>
                <button @click="closeParameterConfirmModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <!-- Detected Tool -->
                <div x-show="detectedTool" class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">ğŸ”§ æ¤œå‡ºã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«</h3>
                    <div class="text-lg font-bold text-indigo-700" x-text="detectedTool?.tool_name"></div>
                    <div class="text-sm text-gray-600 mt-1" x-text="detectedTool?.description"></div>
                    <div class="text-xs text-gray-500 mt-2">
                        ä¿¡é ¼åº¦: <span x-text="detectedTool?.confidence ? (detectedTool.confidence * 100).toFixed(0) + '%' : 'N/A'"></span>
                    </div>
                </div>

                <!-- Extracted Parameters -->
                <div x-show="extractedParameters" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">ğŸ“‹ æŠ½å‡ºã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h3>
                    <div class="space-y-2">
                        <template x-for="(value, key) in extractedParameters" :key="key">
                            <div class="flex items-center gap-2 text-sm">
                                <span class="font-medium text-gray-700 w-1/3" x-text="key + ':'"></span>
                                <span class="text-gray-900 flex-1" x-text="formatParamValue(value)"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Error Display -->
                <div x-show="extractionError" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                    <h3 class="text-sm font-semibold text-red-700 mb-2">âŒ ã‚¨ãƒ©ãƒ¼</h3>
                    <div class="text-sm text-red-600" x-text="extractionError"></div>
                </div>

                <!-- Original User Text -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">ğŸ’¬ å…ƒã®å…¥åŠ›</h3>
                    <div class="text-sm text-gray-600" x-text="pendingUserMessage"></div>
                </div>
            </div>

            <div class="modal-footer">
                <button
                    @click="closeParameterConfirmModal()"
                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors"
                >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button
                    x-show="!extractionError"
                    @click="confirmAndExecute()"
                    class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors"
                >
                    å®Ÿè¡Œã™ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- Excel MESSA Modal -->
    <div x-show="showExcelMESSAModal" x-cloak class="modal-overlay" @click.self="closeExcelMESSAModal()">
        <div class="modal-content" style="max-width: 600px;" @click.away="closeExcelMESSAModal()">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-800">ğŸ“Š Excelã§å®‰å…¨åœ¨åº«æœ€é©åŒ–ï¼ˆMESSAï¼‰</h2>
                <button @click="closeExcelMESSAModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <p class="text-sm text-gray-600 mb-6">
                    Excelãƒ•ã‚¡ã‚¤ãƒ«ã§å“ç›®ãƒ‡ãƒ¼ã‚¿ã¨BOMãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ã€ãƒãƒ«ãƒã‚¨ã‚·ãƒ¥ãƒ­ãƒ³ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ã®å®‰å…¨åœ¨åº«é…ç½®ã‚’æœ€é©åŒ–ã—ã¾ã™ã€‚
                </p>

                <!-- Step 1: Download Template -->
                <div class="mb-6">
                    <h3 class="text-md font-semibold text-gray-800 mb-3">ã‚¹ãƒ†ãƒƒãƒ—1: Excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h3>
                    <button
                        @click="downloadExcelTemplate()"
                        class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>

                <!-- Step 2: Fill Data -->
                <div class="mb-6">
                    <h3 class="text-md font-semibold text-gray-800 mb-3">ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›</h3>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
                        <p class="font-medium mb-2">ğŸ“ å…¥åŠ›å†…å®¹ï¼š</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li><strong>å“ç›®ã‚·ãƒ¼ãƒˆ</strong>: å“ç›®åã€å‡¦ç†æ™‚é–“ã€å¹³å‡éœ€è¦ã€æ¨™æº–åå·®ã€ã‚³ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿</li>
                            <li><strong>éƒ¨å“å±•é–‹è¡¨ã‚·ãƒ¼ãƒˆ</strong>: è¦ªå­é–¢ä¿‚ã€æ•°é‡</li>
                        </ul>
                    </div>
                </div>

                <!-- Step 3: Upload File -->
                <div class="mb-4">
                    <h3 class="text-md font-semibold text-gray-800 mb-3">ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€é©åŒ–å®Ÿè¡Œ</h3>
                    <label class="block w-full">
                        <input
                            type="file"
                            accept=".xlsx,.xls"
                            @change="uploadExcelFile($event)"
                            class="w-full px-4 py-3 border-2 border-dashed border-gray-300 hover:border-blue-400 rounded-lg cursor-pointer file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 transition-colors"
                        />
                    </label>
                    <p class="text-xs text-gray-500 mt-2">
                        Excelãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.xlsx ã¾ãŸã¯ .xlsï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„
                    </p>
                </div>
            </div>

            <div class="modal-footer">
                <button
                    @click="closeExcelMESSAModal()"
                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition-colors"
                >
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- Table MESSA Modal -->
    <div x-show="showTableMESSAModal" x-cloak class="modal-overlay" @click.self="closeTableMESSAModal()">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;" @click.away="closeTableMESSAModal()">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-800">ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«ã§å®‰å…¨åœ¨åº«æœ€é©åŒ–ï¼ˆMESSAï¼‰</h2>
                <button @click="closeTableMESSAModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <p class="text-sm text-gray-600 mb-6">
                    å“ç›®ãƒ‡ãƒ¼ã‚¿ã¨BOMãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§å…¥åŠ›ã—ã¦ã€ãƒãƒ«ãƒã‚¨ã‚·ãƒ¥ãƒ­ãƒ³ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ã®å®‰å…¨åœ¨åº«é…ç½®ã‚’æœ€é©åŒ–ã—ã¾ã™ã€‚
                </p>

                <!-- å“ç›®ãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-md font-semibold text-gray-800">å“ç›®ãƒ‡ãƒ¼ã‚¿</h3>
                        <button
                            @click="addItemRow()"
                            class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition-colors"
                        >
                            + è¡Œã‚’è¿½åŠ 
                        </button>
                    </div>

                    <div class="overflow-x-auto border border-gray-300 rounded-lg">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 border-b border-gray-300">
                                <tr>
                                    <th class="px-2 py-2 text-left">å“ç›®å*</th>
                                    <th class="px-2 py-2 text-left">å‡¦ç†æ™‚é–“</th>
                                    <th class="px-2 py-2 text-left">æœ€å¤§<br/>ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“</th>
                                    <th class="px-2 py-2 text-left">å¹³å‡éœ€è¦*</th>
                                    <th class="px-2 py-2 text-left">éœ€è¦æ¨™æº–åå·®*</th>
                                    <th class="px-2 py-2 text-left">ä¿ç®¡è²»ç”¨</th>
                                    <th class="px-2 py-2 text-left">æ¬ å“è²»ç”¨</th>
                                    <th class="px-2 py-2 text-left">å›ºå®šè²»ç”¨</th>
                                    <th class="px-2 py-2 text-center">å‰Šé™¤</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(item, index) in tableItems" :key="index">
                                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                                        <td class="px-2 py-2">
                                            <input type="text" x-model="item.name" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="å“ç›®A" />
                                        </td>
                                        <td class="px-2 py-2">
                                            <input type="number" x-model.number="item.process_time" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" min="0" step="1" />
                                        </td>
                                        <td class="px-2 py-2">
                                            <input type="number" x-model.number="item.max_service_time" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" min="0" step="1" />
                                        </td>
                                        <td class="px-2 py-2">
                                            <input type="number" x-model.number="item.avg_demand" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" min="0" step="0.1" placeholder="100" />
                                        </td>
                                        <td class="px-2 py-2">
                                            <input type="number" x-model.number="item.demand_std" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" min="0" step="0.1" placeholder="20" />
                                        </td>
                                        <td class="px-2 py-2">
                                            <input type="number" x-model.number="item.holding_cost" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" min="0" step="0.1" />
                                        </td>
                                        <td class="px-2 py-2">
                                            <input type="number" x-model.number="item.stockout_cost" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" min="0" step="1" />
                                        </td>
                                        <td class="px-2 py-2">
                                            <input type="number" x-model.number="item.fixed_cost" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" min="0" step="1" />
                                        </td>
                                        <td class="px-2 py-2 text-center">
                                            <button
                                                @click="removeItemRow(index)"
                                                :disabled="tableItems.length === 1"
                                                :class="tableItems.length === 1 ? 'text-gray-300 cursor-not-allowed' : 'text-red-600 hover:text-red-800'"
                                                class="text-sm"
                                            >
                                                ğŸ—‘ï¸
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">* ã¯å¿…é ˆé …ç›®ã§ã™</p>
                </div>

                <!-- BOMãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-md font-semibold text-gray-800">BOMï¼ˆéƒ¨å“å±•é–‹è¡¨ï¼‰ãƒ‡ãƒ¼ã‚¿</h3>
                        <button
                            @click="addBOMRow()"
                            class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition-colors"
                        >
                            + è¡Œã‚’è¿½åŠ 
                        </button>
                    </div>

                    <div class="overflow-x-auto border border-gray-300 rounded-lg">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 border-b border-gray-300">
                                <tr>
                                    <th class="px-3 py-2 text-left">å­å“ç›®*</th>
                                    <th class="px-3 py-2 text-left">è¦ªå“ç›®*</th>
                                    <th class="px-3 py-2 text-left">æ•°é‡</th>
                                    <th class="px-3 py-2 text-center">å‰Šé™¤</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(bom, index) in tableBOM" :key="index">
                                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                                        <td class="px-3 py-2">
                                            <input type="text" x-model="bom.child" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="å“ç›®B" />
                                        </td>
                                        <td class="px-3 py-2">
                                            <input type="text" x-model="bom.parent" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="å“ç›®A" />
                                        </td>
                                        <td class="px-3 py-2">
                                            <input type="number" x-model.number="bom.quantity" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" min="1" step="1" />
                                        </td>
                                        <td class="px-3 py-2 text-center">
                                            <button
                                                @click="removeBOMRow(index)"
                                                :disabled="tableBOM.length === 1"
                                                :class="tableBOM.length === 1 ? 'text-gray-300 cursor-not-allowed' : 'text-red-600 hover:text-red-800'"
                                                class="text-sm"
                                            >
                                                ğŸ—‘ï¸
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">* ã¯å¿…é ˆé …ç›®ã§ã™</p>
                </div>
            </div>

            <div class="modal-footer">
                <button
                    @click="closeTableMESSAModal()"
                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition-colors"
                >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button
                    @click="submitTableMESSA()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
                >
                    æœ€é©åŒ–ã‚’å®Ÿè¡Œ
                </button>
            </div>
        </div>
    </div>

    <script>
        function chatApp() {
            return {
                messages: [],
                userInput: '',
                isLoading: false,
                modelName: 'qwen2.5:latest', // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼‰
                skipAuth: false, // èªè¨¼ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°
                autoDetectMode: false, // è‡ªå‹•ãƒ„ãƒ¼ãƒ«æ¤œå‡ºãƒ¢ãƒ¼ãƒ‰

                // Modal states
                showSupplyChainModal: false,
                showGuidedModal: false,
                showParameterConfirmModal: false, // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
                showExcelMESSAModal: false, // Excelã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«
                showTableMESSAModal: false, // ãƒ†ãƒ¼ãƒ–ãƒ«å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«

                // Table Input Data
                tableItems: [
                    { name: '', process_time: 1, max_service_time: 0, avg_demand: '', demand_std: '', holding_cost: 1, stockout_cost: 100, fixed_cost: 1000 }
                ],
                tableBOM: [
                    { child: '', parent: '', quantity: 1 }
                ],

                // Parameter extraction state
                detectedTool: null,
                extractedParameters: null,
                extractionError: null,
                pendingUserMessage: '', // ä¿ç•™ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

                // Guided Form State
                guidedForm: {
                    step: 1, // 1: category selection, 2: function selection, 3: parameter input
                    selectedCategory: null,
                    selectedFunction: null,
                    parameters: {}
                },

                // Function Categories and Definitions
                functionCategories: [
                    {
                        id: 'simulation',
                        name: 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
                        icon: 'ğŸ²',
                        description: 'åœ¨åº«æ–¹ç­–ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
                        functions: [
                            { id: 'simulate_qr', name: '(Q,R)é€£ç¶šç™ºæ³¨æ–¹ç­–', icon: 'ğŸ“Š' },
                            { id: 'simulate_ss', name: '(s,S)é€£ç¶šç™ºæ³¨æ–¹ç­–', icon: 'ğŸ“ˆ' },
                            { id: 'simulate_base_stock', name: 'åŸºåœ¨åº«æ–¹ç­–', icon: 'ğŸ“‰' },
                            { id: 'base_stock_simulation_using_dist', name: 'åˆ†å¸ƒãƒ™ãƒ¼ã‚¹åŸºåœ¨åº«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', icon: 'ğŸ¯' }
                        ]
                    },
                    {
                        id: 'optimization',
                        name: 'åœ¨åº«æœ€é©åŒ–',
                        icon: 'âš™ï¸',
                        description: 'ç™ºæ³¨æ–¹ç­–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æœ€é©åŒ–',
                        functions: [
                            { id: 'optimize_qr', name: '(Q,R)æ–¹ç­–ã®æœ€é©åŒ–', icon: 'ğŸ”§' },
                            { id: 'optimize_ss', name: '(s,S)æ–¹ç­–ã®æœ€é©åŒ–', icon: 'ğŸ”¨' },
                            { id: 'optimize_periodic', name: 'å®šæœŸç™ºæ³¨æ–¹ç­–ã®æœ€é©åŒ–', icon: 'âš¡' },
                            { id: 'optimize_safety_stock', name: 'å®‰å…¨åœ¨åº«é…ç½®ã®æœ€é©åŒ–', icon: 'ğŸ›¡ï¸' }
                        ]
                    },
                    {
                        id: 'forecast',
                        name: 'éœ€è¦äºˆæ¸¬ãƒ»åˆ†æ',
                        icon: 'ğŸ“ˆ',
                        description: 'éœ€è¦ãƒ‡ãƒ¼ã‚¿ã®åˆ†æã¨äºˆæ¸¬',
                        functions: [
                            { id: 'forecast_demand', name: 'éœ€è¦äºˆæ¸¬ï¼ˆæŒ‡æ•°å¹³æ»‘æ³•/ç§»å‹•å¹³å‡ï¼‰', icon: 'ğŸ”®' },
                            { id: 'analyze_demand', name: 'éœ€è¦ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ', icon: 'ğŸ“Š' },
                            { id: 'find_best_distribution', name: 'æœ€é©åˆ†å¸ƒãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°', icon: 'ğŸ“‰' },
                            { id: 'fit_histogram', name: 'ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ åˆ†å¸ƒ', icon: 'ğŸ“Š' }
                        ]
                    },
                    {
                        id: 'calculation',
                        name: 'åœ¨åº«è¨ˆç®—',
                        icon: 'ğŸ§®',
                        description: 'åŸºæœ¬çš„ãªåœ¨åº«è¨ˆç®—',
                        functions: [
                            { id: 'calculate_safety_stock', name: 'å®‰å…¨åœ¨åº«è¨ˆç®—', icon: 'ğŸ›¡ï¸' },
                            { id: 'calculate_eoq_incremental', name: 'EOQï¼ˆå¢—åˆ†æ•°é‡å‰²å¼•ï¼‰', icon: 'ğŸ“¦' },
                            { id: 'calculate_eoq_all_units', name: 'EOQï¼ˆå…¨å˜ä½æ•°é‡å‰²å¼•ï¼‰', icon: 'ğŸ“¦' },
                            { id: 'calculate_wagner_whitin', name: 'Wagner-Whitinã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ', icon: 'ğŸ“Š' }
                        ]
                    }
                ],

                // Function Parameter Templates
                functionTemplates: {
                    'calculate_safety_stock': {
                        name: 'å®‰å…¨åœ¨åº«è¨ˆç®—',
                        description: 'éœ€è¦ã®å¤‰å‹•ã¨ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ã‹ã‚‰å®‰å…¨åœ¨åº«ã‚’è¨ˆç®—ã—ã¾ã™',
                        fields: [
                            { name: 'mu', label: 'éœ€è¦ã®å¹³å‡ï¼ˆå€‹/æ—¥ï¼‰', type: 'number', default: 100, required: true, help: '1æ—¥ã‚ãŸã‚Šã®å¹³å‡éœ€è¦é‡' },
                            { name: 'sigma', label: 'éœ€è¦ã®æ¨™æº–åå·®ï¼ˆå€‹/æ—¥ï¼‰', type: 'number', default: 15, required: true, help: 'éœ€è¦ã®ã°ã‚‰ã¤ã' },
                            { name: 'lead_time', label: 'ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ï¼ˆæ—¥ï¼‰', type: 'number', default: 7, required: true, help: 'ç™ºæ³¨ã‹ã‚‰ç´å“ã¾ã§ã®æ—¥æ•°' },
                            { name: 'service_level', label: 'ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ãƒ™ãƒ«', type: 'number', default: 0.95, min: 0.5, max: 0.999, step: 0.01, required: true, help: 'åœ¨åº«åˆ‡ã‚Œã‚’é˜²ãç¢ºç‡ï¼ˆ0.95 = 95%ï¼‰' }
                        ]
                    },
                    'forecast_demand': {
                        name: 'éœ€è¦äºˆæ¸¬',
                        description: 'éå»ã®éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å°†æ¥ã®éœ€è¦ã‚’äºˆæ¸¬ã—ã¾ã™',
                        fields: [
                            { name: 'demand_history', label: 'éå»ã®éœ€è¦ãƒ‡ãƒ¼ã‚¿', type: 'array', default: '[100, 105, 98, 110, 102]', required: true, help: 'éå»ã®éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›' },
                            { name: 'forecast_periods', label: 'äºˆæ¸¬æœŸé–“', type: 'number', default: 10, required: true, help: 'ä½•æœŸå…ˆã¾ã§äºˆæ¸¬ã™ã‚‹ã‹' },
                            { name: 'method', label: 'äºˆæ¸¬æ‰‹æ³•', type: 'select', options: [
                                { value: 'exponential_smoothing', label: 'æŒ‡æ•°å¹³æ»‘æ³•' },
                                { value: 'moving_average', label: 'ç§»å‹•å¹³å‡æ³•' },
                                { value: 'linear_trend', label: 'ç·šå½¢ãƒˆãƒ¬ãƒ³ãƒ‰æ³•' }
                            ], default: 'exponential_smoothing', required: true }
                        ]
                    },
                    'analyze_demand': {
                        name: 'éœ€è¦ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ',
                        description: 'éœ€è¦ãƒ‡ãƒ¼ã‚¿ã®çµ±è¨ˆçš„åˆ†æã‚’è¡Œã„ã€å¹³å‡ã€æ¨™æº–åå·®ã€å¤‰å‹•ä¿‚æ•°ãªã©ã‚’è¨ˆç®—ã—ã¾ã™ã€‚éœ€è¦ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç†è§£ã¨åœ¨åº«æ–¹ç­–ã®é¸æŠã«å½¹ç«‹ã¡ã¾ã™',
                        fields: [
                            { name: 'demand', label: 'éœ€è¦ãƒ‡ãƒ¼ã‚¿', type: 'array', default: '[100, 105, 98, 110, 102, 95, 108, 103, 97, 112]', required: true, help: 'éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹: 10, 12, 8, 15, 11ï¼‰' }
                        ]
                    },
                    'find_best_distribution': {
                        name: 'æœ€é©åˆ†å¸ƒãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°',
                        description: 'éœ€è¦ãƒ‡ãƒ¼ã‚¿ã«æœ€é©ãªç¢ºç‡åˆ†å¸ƒã‚’è‡ªå‹•çš„ã«è¦‹ã¤ã‘ã¦ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã—ã¾ã™ã€‚æ­£è¦åˆ†å¸ƒã€ã‚¬ãƒ³ãƒåˆ†å¸ƒã€å¯¾æ•°æ­£è¦åˆ†å¸ƒãªã©è¤‡æ•°ã®åˆ†å¸ƒã‚’è©¦ã—ã€æœ€ã‚‚é©åˆåº¦ã®é«˜ã„ã‚‚ã®ã‚’é¸æŠã—ã¾ã™',
                        fields: [
                            { name: 'demand', label: 'éœ€è¦ãƒ‡ãƒ¼ã‚¿', type: 'array', default: '[100, 105, 98, 110, 102, 95, 108, 103, 97, 112, 101, 99, 106, 104, 98]', required: true, help: 'éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã€‚ãƒ‡ãƒ¼ã‚¿æ•°ãŒå¤šã„ã»ã©æ­£ç¢ºã«ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã§ãã¾ã™' }
                        ]
                    },
                    'fit_histogram': {
                        name: 'ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ åˆ†å¸ƒãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°',
                        description: 'ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã‚’ä½œæˆã—ã€éœ€è¦ãƒ‡ãƒ¼ã‚¿ã®åˆ†å¸ƒã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚ãƒ“ãƒ³æ•°ã‚’èª¿æ•´ã—ã¦åˆ†å¸ƒã®è©³ç´°ã‚’æŠŠæ¡ã§ãã¾ã™',
                        fields: [
                            { name: 'demand_data', label: 'éœ€è¦ãƒ‡ãƒ¼ã‚¿', type: 'array', default: '[100, 105, 98, 110, 102, 95, 108, 103, 97, 112, 101, 99, 106, 104, 98]', required: true, help: 'éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›' },
                            { name: 'nbins', label: 'ãƒ“ãƒ³æ•°', type: 'number', default: 50, required: false, help: 'ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã®ãƒ“ãƒ³æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50ï¼‰' }
                        ]
                    },
                    'calculate_eoq_incremental': {
                        name: 'EOQè¨ˆç®—ï¼ˆå¢—åˆ†æ•°é‡å‰²å¼•ï¼‰',
                        description: 'æ•°é‡å‰²å¼•ã‚’è€ƒæ…®ã—ãŸçµŒæ¸ˆçš„ç™ºæ³¨é‡ã‚’è¨ˆç®—ã—ã¾ã™',
                        fields: [
                            { name: 'annual_demand', label: 'å¹´é–“éœ€è¦ï¼ˆå€‹ï¼‰', type: 'number', default: 12000, required: true },
                            { name: 'order_cost', label: 'ç™ºæ³¨ã‚³ã‚¹ãƒˆï¼ˆå††ï¼‰', type: 'number', default: 500, required: true },
                            { name: 'holding_cost_rate', label: 'åœ¨åº«ä¿ç®¡è²»ç‡ï¼ˆ%ï¼‰', type: 'number', default: 20, required: true, help: 'å¹´é–“ã®åœ¨åº«ä¿ç®¡è²»ç”¨ç‡' },
                            { name: 'price_table', label: 'å˜ä¾¡ãƒ†ãƒ¼ãƒ–ãƒ«', type: 'table', columns: ['æ•°é‡', 'å˜ä¾¡'], default: [[0, 12.0], [500, 11.5], [1000, 11.0]], required: true }
                        ]
                    },
                    'simulate_qr': {
                        name: '(Q,R)é€£ç¶šç™ºæ³¨æ–¹ç­–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
                        description: 'ç™ºæ³¨é‡Qã¨ç™ºæ³¨ç‚¹Rã‚’ä½¿ã£ãŸé€£ç¶šç›£è¦–å‹åœ¨åº«æ–¹ç­–',
                        fields: [
                            { name: 'n_samples', label: 'ã‚µãƒ³ãƒ—ãƒ«æ•°', type: 'number', default: 100, required: false },
                            { name: 'n_periods', label: 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“', type: 'number', default: 200, required: false },
                            { name: 'Q', label: 'ç™ºæ³¨é‡Qï¼ˆå€‹ï¼‰', type: 'number', default: 150, required: true },
                            { name: 'R', label: 'ç™ºæ³¨ç‚¹Rï¼ˆå€‹ï¼‰', type: 'number', default: 80, required: true },
                            { name: 'mu', label: 'éœ€è¦ã®å¹³å‡ï¼ˆå€‹/æ—¥ï¼‰', type: 'number', default: 100, required: true },
                            { name: 'sigma', label: 'éœ€è¦ã®æ¨™æº–åå·®', type: 'number', default: 15, required: true },
                            { name: 'lead_time', label: 'ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ï¼ˆæ—¥ï¼‰', type: 'number', default: 5, required: true },
                            { name: 'holding_cost', label: 'åœ¨åº«ä¿ç®¡è²»ç”¨ï¼ˆå††/å€‹/æ—¥ï¼‰', type: 'number', default: 1.0, required: true },
                            { name: 'stockout_cost', label: 'å“åˆ‡ã‚Œã‚³ã‚¹ãƒˆï¼ˆå††/å€‹ï¼‰', type: 'number', default: 100, required: true },
                            { name: 'fixed_cost', label: 'å›ºå®šç™ºæ³¨ã‚³ã‚¹ãƒˆï¼ˆå††ï¼‰', type: 'number', default: 500, required: true }
                        ]
                    },
                    'simulate_ss': {
                        name: '(s,S)é€£ç¶šç™ºæ³¨æ–¹ç­–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
                        description: 'ç™ºæ³¨ç‚¹sã¨åŸºåœ¨åº«ãƒ¬ãƒ™ãƒ«Sã‚’ä½¿ã£ãŸé€£ç¶šç›£è¦–å‹åœ¨åº«æ–¹ç­–',
                        fields: [
                            { name: 'n_samples', label: 'ã‚µãƒ³ãƒ—ãƒ«æ•°', type: 'number', default: 100, required: false },
                            { name: 'n_periods', label: 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“', type: 'number', default: 200, required: false },
                            { name: 's', label: 'ç™ºæ³¨ç‚¹sï¼ˆå€‹ï¼‰', type: 'number', default: 80, required: true },
                            { name: 'S', label: 'åŸºåœ¨åº«ãƒ¬ãƒ™ãƒ«Sï¼ˆå€‹ï¼‰', type: 'number', default: 200, required: true },
                            { name: 'mu', label: 'éœ€è¦ã®å¹³å‡ï¼ˆå€‹/æ—¥ï¼‰', type: 'number', default: 100, required: true },
                            { name: 'sigma', label: 'éœ€è¦ã®æ¨™æº–åå·®', type: 'number', default: 15, required: true },
                            { name: 'lead_time', label: 'ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ï¼ˆæ—¥ï¼‰', type: 'number', default: 5, required: true },
                            { name: 'holding_cost', label: 'åœ¨åº«ä¿ç®¡è²»ç”¨ï¼ˆå††/å€‹/æ—¥ï¼‰', type: 'number', default: 1.0, required: true },
                            { name: 'stockout_cost', label: 'å“åˆ‡ã‚Œã‚³ã‚¹ãƒˆï¼ˆå††/å€‹ï¼‰', type: 'number', default: 100, required: true },
                            { name: 'fixed_cost', label: 'å›ºå®šç™ºæ³¨ã‚³ã‚¹ãƒˆï¼ˆå††ï¼‰', type: 'number', default: 500, required: true }
                        ]
                    },
                    'optimize_qr': {
                        name: '(Q,R)æ–¹ç­–ã®æœ€é©åŒ–',
                        description: '(Q,R)æ–¹ç­–ã®æœ€é©ãªç™ºæ³¨é‡Qã¨ç™ºæ³¨ç‚¹Rã‚’è¨ˆç®—ã—ã¾ã™',
                        fields: [
                            { name: 'mu', label: 'éœ€è¦ã®å¹³å‡ï¼ˆå€‹/æ—¥ï¼‰', type: 'number', default: 100, required: true },
                            { name: 'sigma', label: 'éœ€è¦ã®æ¨™æº–åå·®', type: 'number', default: 15, required: true },
                            { name: 'lead_time', label: 'ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ï¼ˆæ—¥ï¼‰', type: 'number', default: 5, required: true },
                            { name: 'holding_cost', label: 'åœ¨åº«ä¿ç®¡è²»ç”¨ï¼ˆå††/å€‹/æ—¥ï¼‰', type: 'number', default: 1.0, required: true },
                            { name: 'stockout_cost', label: 'å“åˆ‡ã‚Œã‚³ã‚¹ãƒˆï¼ˆå††/å€‹ï¼‰', type: 'number', default: 100, required: true },
                            { name: 'fixed_cost', label: 'å›ºå®šç™ºæ³¨ã‚³ã‚¹ãƒˆï¼ˆå††ï¼‰', type: 'number', default: 500, required: true }
                        ]
                    },
                    'optimize_ss': {
                        name: '(s,S)æ–¹ç­–ã®æœ€é©åŒ–',
                        description: '(s,S)æ–¹ç­–ã®æœ€é©ãªç™ºæ³¨ç‚¹sã¨åŸºåœ¨åº«ãƒ¬ãƒ™ãƒ«Sã‚’è¨ˆç®—ã—ã¾ã™',
                        fields: [
                            { name: 'mu', label: 'éœ€è¦ã®å¹³å‡ï¼ˆå€‹/æ—¥ï¼‰', type: 'number', default: 100, required: true },
                            { name: 'sigma', label: 'éœ€è¦ã®æ¨™æº–åå·®', type: 'number', default: 15, required: true },
                            { name: 'lead_time', label: 'ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ï¼ˆæ—¥ï¼‰', type: 'number', default: 5, required: true },
                            { name: 'holding_cost', label: 'åœ¨åº«ä¿ç®¡è²»ç”¨ï¼ˆå††/å€‹/æ—¥ï¼‰', type: 'number', default: 1.0, required: true },
                            { name: 'stockout_cost', label: 'å“åˆ‡ã‚Œã‚³ã‚¹ãƒˆï¼ˆå††/å€‹ï¼‰', type: 'number', default: 100, required: true },
                            { name: 'fixed_cost', label: 'å›ºå®šç™ºæ³¨ã‚³ã‚¹ãƒˆï¼ˆå††ï¼‰', type: 'number', default: 500, required: true }
                        ]
                    },
                    'simulate_base_stock': {
                        name: 'åŸºåœ¨åº«æ–¹ç­–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
                        description: 'å®šæœŸç™ºæ³¨æ–¹å¼ã§åŸºåœ¨åº«ãƒ¬ãƒ™ãƒ«ã¾ã§è£œå……ã™ã‚‹æ–¹ç­–ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
                        fields: [
                            { name: 'mu', label: 'éœ€è¦ã®å¹³å‡ï¼ˆå€‹/æ—¥ï¼‰', type: 'number', default: 100, required: true, help: 'éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™' },
                            { name: 'sigma', label: 'éœ€è¦ã®æ¨™æº–åå·®', type: 'number', default: 15, required: true },
                            { name: 'n_samples', label: 'ã‚µãƒ³ãƒ—ãƒ«æ•°', type: 'number', default: 100, required: false },
                            { name: 'n_periods', label: 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“', type: 'number', default: 200, required: false },
                            { name: 'base_stock_level', label: 'åŸºåœ¨åº«ãƒ¬ãƒ™ãƒ«Sï¼ˆå€‹ï¼‰', type: 'number', default: 200, required: true },
                            { name: 'lead_time', label: 'ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ï¼ˆæ—¥ï¼‰', type: 'number', default: 5, required: true },
                            { name: 'capacity', label: 'ç”Ÿç”£èƒ½åŠ›ï¼ˆå€‹/æ—¥ï¼‰', type: 'number', default: 1000, required: false, help: 'ç„¡åˆ¶é™ã®å ´åˆã¯å¤§ããªå€¤ã‚’è¨­å®š' },
                            { name: 'holding_cost', label: 'åœ¨åº«ä¿ç®¡è²»ç”¨ï¼ˆå††/å€‹/æ—¥ï¼‰', type: 'number', default: 1.0, required: true },
                            { name: 'stockout_cost', label: 'å“åˆ‡ã‚Œã‚³ã‚¹ãƒˆï¼ˆå††/å€‹ï¼‰', type: 'number', default: 100, required: true }
                        ]
                    },
                    'base_stock_simulation_using_dist': {
                        name: 'åˆ†å¸ƒãƒ™ãƒ¼ã‚¹åŸºåœ¨åº«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
                        description: 'ç¢ºç‡åˆ†å¸ƒã‹ã‚‰éœ€è¦ã‚’ç”Ÿæˆã—ã¦åŸºåœ¨åº«æ–¹ç­–ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
                        fields: [
                            { name: 'n_samples', label: 'ã‚µãƒ³ãƒ—ãƒ«æ•°', type: 'number', default: 100, required: false },
                            { name: 'n_periods', label: 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“', type: 'number', default: 200, required: false },
                            { name: 'dist_type', label: 'éœ€è¦åˆ†å¸ƒã‚¿ã‚¤ãƒ—', type: 'select', options: [
                                { value: 'normal', label: 'æ­£è¦åˆ†å¸ƒ' },
                                { value: 'gamma', label: 'ã‚¬ãƒ³ãƒåˆ†å¸ƒ' },
                                { value: 'poisson', label: 'ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ' },
                                { value: 'uniform', label: 'ä¸€æ§˜åˆ†å¸ƒ' },
                                { value: 'exponential', label: 'æŒ‡æ•°åˆ†å¸ƒ' },
                                { value: 'lognormal', label: 'å¯¾æ•°æ­£è¦åˆ†å¸ƒ' }
                            ], default: 'normal', required: true },
                            { name: 'dist_mu', label: 'åˆ†å¸ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: å¹³å‡ (mu)', type: 'number', default: 100, required: true },
                            { name: 'dist_sigma', label: 'åˆ†å¸ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: æ¨™æº–åå·® (sigma)', type: 'number', default: 15, required: true, help: 'æ­£è¦åˆ†å¸ƒã®å ´åˆ' },
                            { name: 'base_stock_level', label: 'åŸºåœ¨åº«ãƒ¬ãƒ™ãƒ«Sï¼ˆå€‹ï¼‰', type: 'number', default: 200, required: false, help: 'çœç•¥ã™ã‚‹ã¨è‡ªå‹•è¨ˆç®—' },
                            { name: 'lead_time', label: 'ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ï¼ˆæ—¥ï¼‰', type: 'number', default: 5, required: false },
                            { name: 'capacity', label: 'ç”Ÿç”£èƒ½åŠ›ï¼ˆå€‹/æ—¥ï¼‰', type: 'number', default: 1000, required: false },
                            { name: 'holding_cost', label: 'åœ¨åº«ä¿ç®¡è²»ç”¨ï¼ˆå††/å€‹/æ—¥ï¼‰', type: 'number', default: 1.0, required: false },
                            { name: 'backorder_cost', label: 'ãƒãƒƒã‚¯ã‚ªãƒ¼ãƒ€ãƒ¼ã‚³ã‚¹ãƒˆï¼ˆå††/å€‹ï¼‰', type: 'number', default: 100, required: false }
                        ]
                    },
                    'optimize_periodic': {
                        name: 'å®šæœŸç™ºæ³¨æ–¹ç­–ã®æœ€é©åŒ–',
                        description: 'ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å…¨ä½“ã®å®šæœŸç™ºæ³¨æ–¹ç­–ã‚’æœ€é©åŒ–ã—ã¾ã™',
                        fields: [
                            { name: 'note', label: 'æ³¨æ„', type: 'info', default: 'ã“ã®æ©Ÿèƒ½ã¯è¤‡é›‘ãªãŸã‚ã€ã€Œã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³æœ€é©åŒ–ã€ãƒœã‚¿ãƒ³ã‚’ã”åˆ©ç”¨ãã ã•ã„', help: 'ã€Œã‚ˆãä½¿ã†æ©Ÿèƒ½ã€ã®ã€ŒğŸ­ ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³æœ€é©åŒ–ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ã‚ˆã‚Šè©³ç´°ãªè¨­å®šãŒå¯èƒ½ã§ã™ã€‚' }
                        ]
                    },
                    'optimize_safety_stock': {
                        name: 'å®‰å…¨åœ¨åº«é…ç½®ã®æœ€é©åŒ–ï¼ˆMESSAï¼‰',
                        description: 'ãƒãƒ«ãƒã‚¨ã‚·ãƒ¥ãƒ­ãƒ³ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å…¨ä½“ã®å®‰å…¨åœ¨åº«é…ç½®ã‚’æœ€é©åŒ–ã—ã¾ã™',
                        fields: [
                            {
                                name: 'complexity',
                                label: 'ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ã®è¤‡é›‘åº¦',
                                type: 'select',
                                options: [
                                    { value: 'simple', label: 'ã‚·ãƒ³ãƒ—ãƒ«ï¼ˆ3å“ç›®ï¼‰' },
                                    { value: 'standard', label: 'æ¨™æº–ï¼ˆ5å“ç›®ï¼‰' },
                                    { value: 'complex', label: 'è¤‡é›‘ï¼ˆ8å“ç›®ï¼‰' }
                                ],
                                default: 'standard',
                                required: true,
                                help: 'ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦æœ€é©åŒ–ã‚’å®Ÿè¡Œã—ã¾ã™'
                            }
                        ]
                    },
                    'calculate_eoq_raw': {
                        name: 'åŸºæœ¬EOQè¨ˆç®—',
                        description: 'çµŒæ¸ˆç™ºæ³¨é‡ï¼ˆEOQï¼‰ã‚’è¨ˆç®—ã—ã€æœ€é©ãªç™ºæ³¨é‡ã¨ç·ã‚³ã‚¹ãƒˆã‚’ç®—å‡ºã—ã¾ã™',
                        fields: [
                            { name: 'annual_demand', label: 'å¹´é–“éœ€è¦é‡ï¼ˆå€‹/å¹´ï¼‰', type: 'number', default: 15000, required: true, help: 'å¹´é–“ã®ç·éœ€è¦é‡' },
                            { name: 'order_cost', label: 'ç™ºæ³¨å›ºå®šè²»ç”¨ï¼ˆå††/å›ï¼‰', type: 'number', default: 500, required: true, help: '1å›ã®ç™ºæ³¨ã«ã‹ã‹ã‚‹å›ºå®šè²»ç”¨' },
                            { name: 'holding_cost_rate', label: 'åœ¨åº«ä¿ç®¡è²»ç‡ï¼ˆå¹´ç‡ï¼‰', type: 'number', default: 0.25, required: true, help: 'å¹´é–“ã®åœ¨åº«ä¿ç®¡è²»ç‡ï¼ˆä¾‹: 0.25 = 25%ï¼‰' },
                            { name: 'unit_price', label: 'å˜ä¾¡ï¼ˆå††/å€‹ï¼‰', type: 'number', default: 12, required: true, help: 'å•†å“ã®å˜ä¾¡' },
                            { name: 'backorder_cost', label: 'ãƒãƒƒã‚¯ã‚ªãƒ¼ãƒ€ãƒ¼è²»ç”¨ï¼ˆå††/å€‹ï¼‰', type: 'number', default: 0, required: false, help: 'å“åˆ‡ã‚Œæ™‚ã®è²»ç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€0ã®å ´åˆã¯ãƒãƒƒã‚¯ã‚ªãƒ¼ãƒ€ãƒ¼ãªã—ï¼‰' }
                        ]
                    },
                    'calculate_eoq_incremental': {
                        name: 'EOQï¼ˆå¢—åˆ†æ•°é‡å‰²å¼•ï¼‰',
                        description: 'å¢—åˆ†æ•°é‡å‰²å¼•ã‚’è€ƒæ…®ã—ãŸEOQã‚’è¨ˆç®—ã—ã¾ã™ã€‚ç™ºæ³¨é‡ã®å„æ®µéšã§ä¾¡æ ¼ãŒæ®µéšçš„ã«å¤‰ã‚ã‚‹å ´åˆã«ä½¿ç”¨ã—ã¾ã™',
                        fields: [
                            { name: 'K', label: 'ç™ºæ³¨å›ºå®šè²»ç”¨ï¼ˆå††/å›ï¼‰', type: 'number', default: 500, required: true, help: '1å›ã®ç™ºæ³¨ã«ã‹ã‹ã‚‹å›ºå®šè²»ç”¨' },
                            { name: 'd', label: 'å¹³å‡éœ€è¦é‡ï¼ˆå€‹/æ—¥ï¼‰', type: 'number', default: 100, required: true, help: '1æ—¥ã‚ãŸã‚Šã®å¹³å‡éœ€è¦é‡' },
                            { name: 'h', label: 'åœ¨åº«ä¿ç®¡è²»ç”¨ï¼ˆå††/å€‹/æ—¥ï¼‰', type: 'number', default: 0.1, required: true, help: '1å€‹ã‚’1æ—¥ä¿ç®¡ã™ã‚‹ã‚³ã‚¹ãƒˆ' },
                            { name: 'b', label: 'å“åˆ‡ã‚Œè²»ç”¨ï¼ˆå††/å€‹/æ—¥ï¼‰', type: 'number', default: 10, required: true, help: 'å“åˆ‡ã‚Œæ™‚ã®1å€‹ã‚ãŸã‚Š1æ—¥ã®è²»ç”¨' },
                            { name: 'r', label: 'å‰²å¼•ç‡', type: 'number', default: 0.2, required: true, help: 'åœ¨åº«ä¿ç®¡è²»ã®è¨ˆç®—ã«ä½¿ç”¨ã™ã‚‹å‰²å¼•ç‡' },
                            { name: 'unit_costs', label: 'å„ä¾¡æ ¼å¸¯ã®å˜ä¾¡', type: 'array', default: '[12, 11, 10]', required: true, help: 'å„ä¾¡æ ¼å¸¯ã®å˜ä¾¡ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹: 12, 11, 10ï¼‰' },
                            { name: 'quantity_breaks', label: 'å„ä¾¡æ ¼å¸¯ã®æœ€å°ç™ºæ³¨é‡', type: 'array', default: '[0, 100, 200]', required: true, help: 'å„ä¾¡æ ¼å¸¯ã®æœ€å°ç™ºæ³¨é‡ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹: 0, 100, 200ï¼‰' }
                        ]
                    },
                    'calculate_eoq_all_units': {
                        name: 'EOQï¼ˆå…¨å˜ä½æ•°é‡å‰²å¼•ï¼‰',
                        description: 'å…¨å˜ä½æ•°é‡å‰²å¼•ã‚’è€ƒæ…®ã—ãŸEOQã‚’è¨ˆç®—ã—ã¾ã™ã€‚ç™ºæ³¨é‡ã«å¿œã˜ã¦å…¨ä½“ã®ä¾¡æ ¼ãŒå¤‰ã‚ã‚‹å ´åˆã«ä½¿ç”¨ã—ã¾ã™',
                        fields: [
                            { name: 'K', label: 'ç™ºæ³¨å›ºå®šè²»ç”¨ï¼ˆå††/å›ï¼‰', type: 'number', default: 500, required: true, help: '1å›ã®ç™ºæ³¨ã«ã‹ã‹ã‚‹å›ºå®šè²»ç”¨' },
                            { name: 'd', label: 'å¹³å‡éœ€è¦é‡ï¼ˆå€‹/æ—¥ï¼‰', type: 'number', default: 100, required: true, help: '1æ—¥ã‚ãŸã‚Šã®å¹³å‡éœ€è¦é‡' },
                            { name: 'h', label: 'åœ¨åº«ä¿ç®¡è²»ç”¨ï¼ˆå††/å€‹/æ—¥ï¼‰', type: 'number', default: 0.1, required: true, help: '1å€‹ã‚’1æ—¥ä¿ç®¡ã™ã‚‹ã‚³ã‚¹ãƒˆ' },
                            { name: 'b', label: 'å“åˆ‡ã‚Œè²»ç”¨ï¼ˆå††/å€‹/æ—¥ï¼‰', type: 'number', default: 10, required: true, help: 'å“åˆ‡ã‚Œæ™‚ã®1å€‹ã‚ãŸã‚Š1æ—¥ã®è²»ç”¨' },
                            { name: 'r', label: 'å‰²å¼•ç‡', type: 'number', default: 0.2, required: true, help: 'åœ¨åº«ä¿ç®¡è²»ã®è¨ˆç®—ã«ä½¿ç”¨ã™ã‚‹å‰²å¼•ç‡' },
                            { name: 'unit_costs', label: 'å„ä¾¡æ ¼å¸¯ã®å˜ä¾¡', type: 'array', default: '[12, 11, 10]', required: true, help: 'å„ä¾¡æ ¼å¸¯ã®å˜ä¾¡ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹: 12, 11, 10ï¼‰' },
                            { name: 'quantity_breaks', label: 'å„ä¾¡æ ¼å¸¯ã®æœ€å°ç™ºæ³¨é‡', type: 'array', default: '[0, 100, 200]', required: true, help: 'å„ä¾¡æ ¼å¸¯ã®æœ€å°ç™ºæ³¨é‡ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹: 0, 100, 200ï¼‰' }
                        ]
                    },
                    'calculate_wagner_whitin': {
                        name: 'Wagner-Whitinã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ',
                        description: 'å‹•çš„ãƒ­ãƒƒãƒˆã‚µã‚¤ã‚¸ãƒ³ã‚°å•é¡Œã‚’è§£ãã€å°†æ¥ã®éœ€è¦ãŒæ—¢çŸ¥ã®å ´åˆã«ç·ã‚³ã‚¹ãƒˆã‚’æœ€å°åŒ–ã™ã‚‹ç™ºæ³¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¨ˆç®—ã—ã¾ã™',
                        fields: [
                            { name: 'demand', label: 'å„æœŸã®éœ€è¦é‡', type: 'array', default: '[10, 20, 30, 15, 25]', required: true, help: 'å„æœŸã®éœ€è¦é‡ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹: 10, 20, 30, 15ï¼‰' },
                            { name: 'fixed_cost', label: 'å›ºå®šç™ºæ³¨è²»ç”¨ï¼ˆå††/å›ï¼‰', type: 'number', default: 100, required: true, help: 'ç™ºæ³¨ã”ã¨ã«ã‹ã‹ã‚‹å›ºå®šè²»ç”¨' },
                            { name: 'holding_cost', label: 'åœ¨åº«ä¿ç®¡è²»ç”¨ï¼ˆå††/unit/æœŸï¼‰', type: 'number', default: 1, required: true, help: 'åœ¨åº«1å˜ä½ã‚’1æœŸé–“ä¿ç®¡ã™ã‚‹ã‚³ã‚¹ãƒˆ' },
                            { name: 'variable_cost', label: 'å¤‰å‹•ç™ºæ³¨è²»ç”¨ï¼ˆå††/unitï¼‰', type: 'number', default: 0, required: false, help: 'ç™ºæ³¨é‡ã«å¿œã˜ã¦å¤‰ã‚ã‚‹è²»ç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰' }
                        ]
                    }
                },

                // Supply Chain Form Data
                scForm: {
                    numSamples: 50,
                    periods: 200,
                    numStages: 4,
                    meanDemand: 120,
                    stdDemand: 18,
                    backorderCost: 100,
                    fixedOrderCost: 1000,
                    stages: [
                        { leadTime: 3, reorderPoint: 250, baseStockLevel: 400, holdingCost: 0.5 },
                        { leadTime: 2, reorderPoint: 200, baseStockLevel: 320, holdingCost: 1.0 },
                        { leadTime: 2, reorderPoint: 180, baseStockLevel: 300, holdingCost: 2.0 },
                        { leadTime: 1, reorderPoint: 150, baseStockLevel: 250, holdingCost: 5.0 }
                    ]
                },

                async init() {
                    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¨­å®šã‚’å–å¾—
                    try {
                        const response = await fetch('/api/config');
                        if (response.ok) {
                            const config = await response.json();
                            this.modelName = config.model;
                            this.skipAuth = config.skip_auth;
                        }
                    } catch (error) {
                        console.error('Failed to load config:', error);
                    }

                    // Check if user is logged in (unless auth is skipped)
                    if (!this.skipAuth) {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            window.location.href = '/';
                            return;
                        }
                    }

                    // Load messages from localStorage
                    const saved = localStorage.getItem('chatMessages');
                    if (saved) {
                        this.messages = JSON.parse(saved);
                    }
                },

                async sendMessage() {
                    if (!this.userInput.trim() || this.isLoading) return;

                    const userMessage = this.userInput.trim();
                    this.userInput = '';

                    // Check if auto-detect mode is enabled
                    if (this.autoDetectMode) {
                        // Intercept and run detection/extraction workflow
                        await this.detectToolAndExtractParams(userMessage);
                        return;
                    }

                    // Add user message
                    this.messages.push({
                        role: 'user',
                        content: userMessage
                    });

                    this.isLoading = true;
                    this.scrollToBottom();

                    try {
                        const token = localStorage.getItem('token');

                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                messages: this.messages,
                                model: this.modelName
                            })
                        });

                        if (!response.ok) {
                            throw new Error('API request failed');
                        }

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let assistantMessage = '';

                        // Add assistant message placeholder
                        this.messages.push({
                            role: 'assistant',
                            content: ''
                        });

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    const data = line.slice(6);
                                    if (data === '[DONE]') break;

                                    try {
                                        const parsed = JSON.parse(data);
                                        if (parsed.content) {
                                            assistantMessage += parsed.content;
                                            this.messages[this.messages.length - 1].content = assistantMessage;
                                            this.scrollToBottom();
                                        } else if (parsed.function_call) {
                                            // Function callçµæœã‚’è¡¨ç¤º
                                            const funcName = parsed.function_call.name;
                                            const funcResult = parsed.function_call.result;

                                            let funcDisplay = `\n\nğŸ”§ **${funcName}ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ**\n\n`;

                                            // Check if result contains visualization URL or ID
                                            if (funcResult.visualization_url) {
                                                const vizUrl = funcResult.visualization_url;
                                                const message = funcResult.message || 'å¯è¦–åŒ–çµæœã‚’è¡¨ç¤º';
                                                funcDisplay += `ğŸ“Š ${message}\nğŸ”— [å¯è¦–åŒ–ã‚’é–‹ã](${vizUrl})\n\n`;
                                            } else if (funcResult.visualization_id) {
                                                const vizId = funcResult.visualization_id;
                                                const vizUrl = `/api/visualization/${vizId}`;
                                                const message = funcResult.message || 'å¯è¦–åŒ–çµæœã‚’è¡¨ç¤º';
                                                funcDisplay += `ğŸ“Š ${message}\nğŸ”— [å¯è¦–åŒ–ã‚’é–‹ã](${vizUrl})\n\n`;
                                            }

                                            // Display key results if available
                                            if (funcResult.status === 'success') {
                                                funcDisplay += `âœ… **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æˆåŠŸ\n\n`;

                                                // Display important metrics
                                                if (funcResult.message) {
                                                    funcDisplay += `ğŸ“ **çµæœ**: ${funcResult.message}\n\n`;
                                                }

                                                // Extract key metrics to display
                                                const keyMetrics = [];

                                                // EOQ results
                                                if (funcResult.optimal_order_quantity !== undefined) keyMetrics.push(`ğŸ“¦ **æœ€é©ç™ºæ³¨é‡**: ${funcResult.optimal_order_quantity.toFixed(2)} units`);
                                                if (funcResult.total_cost !== undefined) keyMetrics.push(`ğŸ’° **ç·ã‚³ã‚¹ãƒˆ**: ${funcResult.total_cost.toFixed(2)} å††/å¹´`);
                                                if (funcResult.ordering_cost !== undefined) keyMetrics.push(`ğŸ“ ç™ºæ³¨ã‚³ã‚¹ãƒˆ: ${funcResult.ordering_cost.toFixed(2)} å††/å¹´`);
                                                if (funcResult.holding_cost !== undefined) keyMetrics.push(`ğŸ“¦ åœ¨åº«ä¿ç®¡ã‚³ã‚¹ãƒˆ: ${funcResult.holding_cost.toFixed(2)} å††/å¹´`);
                                                if (funcResult.purchase_cost !== undefined) keyMetrics.push(`ğŸ’µ è³¼å…¥ã‚³ã‚¹ãƒˆ: ${funcResult.purchase_cost.toFixed(2)} å††/å¹´`);

                                                // Optimization results
                                                if (funcResult.best_cost !== undefined) keyMetrics.push(`ğŸ’° **ç·ã‚³ã‚¹ãƒˆ**: ${funcResult.best_cost.toFixed(2)}`);
                                                if (funcResult.average_cost !== undefined) keyMetrics.push(`ğŸ“Š å¹³å‡ã‚³ã‚¹ãƒˆ: ${funcResult.average_cost.toFixed(2)}`);
                                                if (funcResult.optimal_Q !== undefined) keyMetrics.push(`ğŸ“¦ **æœ€é©ç™ºæ³¨é‡**: ${funcResult.optimal_Q.toFixed(2)}`);
                                                if (funcResult.iterations !== undefined) keyMetrics.push(`ğŸ”„ åå¾©å›æ•°: ${funcResult.iterations}`);

                                                // Forecast results
                                                if (funcResult.forecast && Array.isArray(funcResult.forecast)) {
                                                    const forecastSummary = funcResult.forecast.slice(0, 3).map(v => v.toFixed(1)).join(', ');
                                                    keyMetrics.push(`ğŸ“ˆ äºˆæ¸¬å€¤: [${forecastSummary}, ...]`);
                                                }

                                                // Distribution fitting results
                                                if (funcResult.best_distribution) {
                                                    keyMetrics.push(`ğŸ“Š **æœ€é©åˆ†å¸ƒ**: ${funcResult.best_distribution}`);
                                                }

                                                if (keyMetrics.length > 0) {
                                                    funcDisplay += `**ä¸»ãªçµæœ**:\n${keyMetrics.map(m => `${m}`).join('\n')}\n\n`;
                                                }
                                            } else if (funcResult.status === 'error') {
                                                funcDisplay += `âŒ **ã‚¨ãƒ©ãƒ¼**: ${funcResult.message}\n\n`;
                                            }

                                            // Add collapsible detailed JSON
                                            const detailsId = `json-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                                            funcDisplay += `<details class="json-collapsible" id="${detailsId}">
                                                <summary class="json-collapsible-header">
                                                    <span>ğŸ“‹ è©³ç´°ãªçµæœã‚’è¡¨ç¤º</span>
                                                    <span class="json-toggle-icon">â–¼</span>
                                                </summary>
                                                <div class="json-collapsible-content">
\`\`\`json
${JSON.stringify(funcResult, null, 2)}
\`\`\`
                                                </div>
                                            </details>\n\n`;

                                            assistantMessage += funcDisplay;
                                            this.messages[this.messages.length - 1].content = assistantMessage;
                                            this.scrollToBottom();
                                        } else if (parsed.error) {
                                            this.messages[this.messages.length - 1].content = `ã‚¨ãƒ©ãƒ¼: ${parsed.error}`;
                                        }
                                    } catch (e) {
                                        // Ignore parse errors
                                    }
                                }
                            }
                        }

                        // Save to localStorage
                        localStorage.setItem('chatMessages', JSON.stringify(this.messages));

                    } catch (error) {
                        console.error('Error:', error);
                        this.messages.push({
                            role: 'assistant',
                            content: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
                        });
                    } finally {
                        this.isLoading = false;
                        this.scrollToBottom();
                    }
                },

                clearChat() {
                    if (confirm('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                        this.messages = [];
                        localStorage.removeItem('chatMessages');
                    }
                },

                logout() {
                    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('chatMessages');
                        window.location.href = '/';
                    }
                },

                scrollToBottom() {
                    this.$nextTick(() => {
                        const container = this.$refs.messageContainer;
                        container.scrollTop = container.scrollHeight;
                    });
                },

                formatMessage(content) {
                    // Configure marked.js
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        headerIds: false,
                        mangle: false,
                        highlight: function(code, lang) {
                            if (lang && hljs.getLanguage(lang)) {
                                try {
                                    return hljs.highlight(code, { language: lang }).value;
                                } catch (err) {}
                            }
                            return hljs.highlightAuto(code).value;
                        }
                    });

                    // Render Markdown to HTML
                    let html = marked.parse(content);

                    // Post-process: Make all links open in new tab
                    html = html.replace(/<a href=/g, '<a target="_blank" href=');

                    // Apply syntax highlighting to code blocks that weren't highlighted
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    tempDiv.querySelectorAll('pre code').forEach((block) => {
                        if (!block.classList.contains('hljs')) {
                            hljs.highlightElement(block);
                        }
                    });

                    return tempDiv.innerHTML;
                },

                // Supply Chain Form Methods
                openSupplyChainForm() {
                    this.showSupplyChainModal = true;
                },

                closeSupplyChainForm() {
                    this.showSupplyChainModal = false;
                },

                // Excel MESSA Form Methods
                openExcelMESSAModal() {
                    this.showExcelMESSAModal = true;
                },

                closeExcelMESSAModal() {
                    this.showExcelMESSAModal = false;
                },

                async downloadExcelTemplate() {
                    try {
                        const token = localStorage.getItem('token');
                        const headers = {};
                        if (token && !this.skipAuth) {
                            headers['Authorization'] = `Bearer ${token}`;
                        }

                        const response = await fetch('/api/download_messa_template', {
                            method: 'GET',
                            headers: headers
                        });

                        if (!response.ok) {
                            throw new Error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }

                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'messa_template.xlsx';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        alert('âœ… Excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                    } catch (error) {
                        console.error('Download error:', error);
                        alert('âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    }
                },

                async uploadExcelFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const token = localStorage.getItem('token');
                        const headers = {};
                        if (token && !this.skipAuth) {
                            headers['Authorization'] = `Bearer ${token}`;
                        }
                        // Don't set Content-Type for FormData - browser will set it with boundary

                        const response = await fetch('/api/upload_messa_excel', {
                            method: 'POST',
                            headers: headers,
                            body: formData
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || 'æœ€é©åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }

                        const result = await response.json();

                        // Display results
                        let resultMessage = `âœ… æœ€é©åŒ–ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nç·ã‚³ã‚¹ãƒˆ: ${result.total_cost.toFixed(2)}å††\n\n`;
                        resultMessage += 'å„æ‹ ç‚¹ã®æœ€é©åœ¨åº«:\n';
                        result.optimization_results.forEach(node => {
                            resultMessage += `- ${node.node}: å®‰å…¨åœ¨åº« ${node.safety_stock.toFixed(2)}, ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ ${node.service_time.toFixed(2)}, ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ  ${node.lead_time.toFixed(2)}\n`;
                        });

                        alert(resultMessage);
                        this.closeExcelMESSAModal();

                    } catch (error) {
                        console.error('Upload error:', error);
                        alert('âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    }
                },

                // Table MESSA Form Methods
                openTableMESSAModal() {
                    this.showTableMESSAModal = true;
                },

                closeTableMESSAModal() {
                    this.showTableMESSAModal = false;
                },

                addItemRow() {
                    this.tableItems.push({
                        name: '',
                        process_time: 1,
                        max_service_time: 0,
                        avg_demand: '',
                        demand_std: '',
                        holding_cost: 1,
                        stockout_cost: 100,
                        fixed_cost: 1000
                    });
                },

                removeItemRow(index) {
                    if (this.tableItems.length > 1) {
                        this.tableItems.splice(index, 1);
                    }
                },

                addBOMRow() {
                    this.tableBOM.push({
                        child: '',
                        parent: '',
                        quantity: 1
                    });
                },

                removeBOMRow(index) {
                    if (this.tableBOM.length > 1) {
                        this.tableBOM.splice(index, 1);
                    }
                },

                async submitTableMESSA() {
                    try {
                        // Validate data
                        for (let item of this.tableItems) {
                            if (!item.name || item.avg_demand === '' || item.demand_std === '') {
                                throw new Error('å“ç›®ãƒ‡ãƒ¼ã‚¿ã«æœªå…¥åŠ›ã®å¿…é ˆé …ç›®ãŒã‚ã‚Šã¾ã™');
                            }
                        }

                        for (let bom of this.tableBOM) {
                            if (!bom.child || !bom.parent) {
                                throw new Error('BOMãƒ‡ãƒ¼ã‚¿ã«æœªå…¥åŠ›ã®å¿…é ˆé …ç›®ãŒã‚ã‚Šã¾ã™');
                            }
                        }

                        // Prepare data
                        const items_data = JSON.stringify(this.tableItems);
                        const bom_data = JSON.stringify(this.tableBOM);

                        // Call optimization API
                        const token = localStorage.getItem('token');
                        const headers = {
                            'Content-Type': 'application/json'
                        };
                        if (token && !this.skipAuth) {
                            headers['Authorization'] = `Bearer ${token}`;
                        }

                        const response = await fetch('/api/tools/optimize_safety_stock', {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({
                                items_data: items_data,
                                bom_data: bom_data
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || 'æœ€é©åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }

                        const result = await response.json();

                        // Display results
                        if (result.status === 'success') {
                            let resultMessage = `âœ… æœ€é©åŒ–ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nç·ã‚³ã‚¹ãƒˆ: ${result.total_cost.toFixed(2)}å††\n\n`;
                            resultMessage += 'å„æ‹ ç‚¹ã®æœ€é©åœ¨åº«:\n';
                            result.optimization_results.forEach(node => {
                                resultMessage += `- ${node.node}: å®‰å…¨åœ¨åº« ${node.safety_stock.toFixed(2)}, ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ ${node.service_time.toFixed(2)}, ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ  ${node.lead_time.toFixed(2)}\n`;
                            });
                            alert(resultMessage);
                            this.closeTableMESSAModal();
                        } else {
                            throw new Error(result.message || 'æœ€é©åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }

                    } catch (error) {
                        console.error('Table MESSA error:', error);
                        alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    }
                },

                updateStageData() {
                    const currentStages = this.scForm.stages.length;
                    const targetStages = this.scForm.numStages;

                    if (targetStages > currentStages) {
                        // Add new stages
                        for (let i = currentStages; i < targetStages; i++) {
                            this.scForm.stages.push({
                                leadTime: 1,
                                reorderPoint: 100,
                                baseStockLevel: 200,
                                holdingCost: 1.0
                            });
                        }
                    } else if (targetStages < currentStages) {
                        // Remove excess stages
                        this.scForm.stages = this.scForm.stages.slice(0, targetStages);
                    }
                },

                submitSupplyChainForm() {
                    // Extract data from form
                    const form = this.scForm;

                    // Build network_data JSON structure
                    const stages = form.stages.map((stage, idx) => ({
                        name: `Stage${idx}`,
                        h: stage.holdingCost,
                        net_replenishment_time: stage.leadTime,
                        initial_s: stage.reorderPoint,
                        initial_S: stage.baseStockLevel
                    }));

                    // Build linear connections (Stage0 -> Stage1 -> Stage2 -> ...)
                    const connections = [];
                    for (let i = 0; i < form.numStages - 1; i++) {
                        connections.push({
                            child: `Stage${i}`,
                            parent: `Stage${i + 1}`
                        });
                    }

                    // Build the demand distribution
                    const demandDist = {
                        type: 'normal',
                        mean: form.meanDemand,
                        std: form.stdDemand
                    };

                    const networkData = {
                        stages: stages,
                        connections: connections,
                        demand_dist: demandDist
                    };

                    // Create a simplified message that the LLM can parse
                    const message = `${form.numStages}æ®µéšã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ã®å®šæœŸç™ºæ³¨æœ€é©åŒ–ã‚’ã—ã¦ãã ã•ã„ã€‚

network_dataã®JSON:
\`\`\`json
${JSON.stringify(networkData, null, 2)}
\`\`\`

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
- algorithm: "sgd"
- max_iter: 100
- n_samples: ${form.numSamples}
- n_periods: ${form.periods}
- backorder_cost: ${form.backorderCost}
- fixed_order_cost: ${form.fixedOrderCost}
- learning_rate: 0.1

optimize_periodic_inventoryé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚æœ€é©åŒ–å®Œäº†å¾Œã€çµæœã‚’å¯è¦–åŒ–ã—ã¦ãã ã•ã„ã€‚`;

                    // Set user input and submit
                    this.userInput = message;
                    this.closeSupplyChainForm();
                    this.sendMessage();
                },

                // Guided Form Methods
                openGuidedForm() {
                    this.guidedForm = {
                        step: 1,
                        selectedCategory: null,
                        selectedFunction: null,
                        parameters: {}
                    };
                    this.showGuidedModal = true;
                },

                closeGuidedForm() {
                    this.showGuidedModal = false;
                },

                selectCategory(category) {
                    this.guidedForm.selectedCategory = category;
                    this.guidedForm.step = 2;
                },

                selectFunction(func) {
                    this.guidedForm.selectedFunction = func;
                    this.guidedForm.step = 3;
                    this.$nextTick(() => {
                        this.renderDynamicForm(func.id);
                    });
                },

                renderDynamicForm(functionId) {
                    const template = this.functionTemplates[functionId];
                    if (!template) return;

                    const container = document.getElementById('dynamicFormFields');
                    container.innerHTML = '';

                    template.fields.forEach(field => {
                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'form-group';

                        // Label
                        const label = document.createElement('label');
                        label.className = 'form-label';
                        label.textContent = field.label + (field.required ? ' *' : '');
                        fieldDiv.appendChild(label);

                        // Help text
                        if (field.help) {
                            const help = document.createElement('div');
                            help.className = 'text-xs text-gray-500 mb-1';
                            help.textContent = field.help;
                            fieldDiv.appendChild(help);
                        }

                        // Input field
                        let input;
                        if (field.type === 'info') {
                            // Info field - display a message with a button to open supply chain form
                            const infoBox = document.createElement('div');
                            infoBox.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-4';

                            const infoText = document.createElement('div');
                            infoText.className = 'text-sm text-yellow-800 mb-3';
                            infoText.textContent = field.default;
                            infoBox.appendChild(infoText);

                            const button = document.createElement('button');
                            button.type = 'button';
                            button.className = 'px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors';
                            button.textContent = 'ğŸ­ ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³æœ€é©åŒ–ã‚’é–‹ã';
                            button.onclick = () => {
                                this.closeGuidedForm();
                                this.openSupplyChainForm();
                            };
                            infoBox.appendChild(button);

                            fieldDiv.appendChild(infoBox);
                            container.appendChild(fieldDiv);
                            return; // Skip normal input processing
                        } else if (field.type === 'select') {
                            input = document.createElement('select');
                            input.className = 'form-input';
                            field.options.forEach(opt => {
                                const option = document.createElement('option');
                                option.value = opt.value;
                                option.textContent = opt.label;
                                if (opt.value === field.default) option.selected = true;
                                input.appendChild(option);
                            });
                        } else if (field.type === 'array') {
                            input = document.createElement('textarea');
                            input.className = 'form-input';
                            input.rows = 3;
                            input.placeholder = 'ä¾‹: 100, 105, 98, 110, 102';
                            input.value = field.default || '';
                        } else {
                            input = document.createElement('input');
                            input.type = field.type;
                            input.className = 'form-input';
                            input.value = field.default || '';
                            if (field.min !== undefined) input.min = field.min;
                            if (field.max !== undefined) input.max = field.max;
                            // Respect field.step if defined, otherwise use 'any' for number inputs
                            if (field.type === 'number') input.step = field.step !== undefined ? field.step : 'any';
                        }

                        input.id = `field_${field.name}`;
                        input.required = field.required;
                        fieldDiv.appendChild(input);

                        container.appendChild(fieldDiv);

                        // Store default value
                        this.guidedForm.parameters[field.name] = field.default;
                    });
                },

                submitGuidedForm() {
                    const template = this.functionTemplates[this.guidedForm.selectedFunction.id];
                    if (!template) return;

                    // Collect form values
                    const params = {};
                    template.fields.forEach(field => {
                        const input = document.getElementById(`field_${field.name}`);
                        if (input) {
                            let value = input.value;
                            if (field.type === 'number') {
                                value = parseFloat(value);
                            } else if (field.type === 'array') {
                                // Parse comma-separated values or JSON array
                                try {
                                    value = JSON.parse('[' + value.replace(/[\[\]]/g, '') + ']');
                                } catch {
                                    value = value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
                                }
                            }
                            params[field.name] = value;
                        }
                    });

                    // Build message for LLM
                    const message = this.buildMessageFromParams(this.guidedForm.selectedFunction.id, template, params);

                    // Submit to chat
                    this.userInput = message;
                    this.closeGuidedForm();
                    this.sendMessage();
                },

                buildMessageFromParams(functionId, template, params) {
                    // Map function IDs to MCP tool names
                    const toolMapping = {
                        'simulate_qr': 'simulate_qr_policy',
                        'simulate_ss': 'simulate_ss_policy',
                        'simulate_base_stock': 'simulate_base_stock_policy',
                        'base_stock_simulation_using_dist': 'base_stock_simulation_using_dist',
                        'optimize_qr': 'optimize_qr_policy',
                        'optimize_ss': 'optimize_ss_policy',
                        'optimize_periodic': 'optimize_periodic_inventory',
                        'optimize_safety_stock': 'optimize_safety_stock_allocation',
                        'calculate_safety_stock': 'calculate_safety_stock',
                        'forecast_demand': 'forecast_demand',
                        'analyze_demand': 'analyze_demand_pattern',
                        'find_best_distribution': 'find_best_distribution',
                        'fit_histogram': 'fit_histogram_distribution',
                        'calculate_eoq_incremental': 'calculate_eoq_incremental_discount_raw',
                        'calculate_eoq_all_units': 'calculate_eoq_all_units_discount_raw',
                        'calculate_wagner_whitin': 'calculate_wagner_whitin'
                    };

                    const toolName = toolMapping[functionId] || functionId;

                    // Special handling for optimize_safety_stock - use generate_sample_data workflow
                    if (functionId === 'optimize_safety_stock') {
                        const complexity = params.complexity || 'standard';
                        const message = `å®‰å…¨åœ¨åº«é…ç½®ã®æœ€é©åŒ–ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ã‚¹ãƒ†ãƒƒãƒ—1: ã¾ãšã€generate_sample_dataé–¢æ•°ã‚’å®Ÿè¡Œã—ã¦ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
complexity: "${complexity}"

ã‚¹ãƒ†ãƒƒãƒ—2: generate_sample_dataã‹ã‚‰è¿”ã•ã‚ŒãŸitems_dataã¨bom_dataã‚’ä½¿ã£ã¦ã€optimize_safety_stock_allocationé–¢æ•°ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

ã‚¹ãƒ†ãƒƒãƒ—3: æœ€é©åŒ–çµæœã‚’æ—¥æœ¬èªã§åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚å„ãƒãƒ¼ãƒ‰ã®æœ€é©å®‰å…¨åœ¨åº«ã€ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ã€ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ã‚’å ±å‘Šã—ã¦ãã ã•ã„ã€‚`;

                        return message;
                    }

                    // Special handling for base_stock_simulation_using_dist
                    if (functionId === 'base_stock_simulation_using_dist') {
                        // Build the demand_dist object from separate fields
                        const demandDist = {
                            type: params.dist_type || 'normal',
                            params: {
                                mu: params.dist_mu,
                                sigma: params.dist_sigma
                            }
                        };

                        // Remove the individual distribution fields and add the constructed object
                        const modifiedParams = { ...params };
                        delete modifiedParams.dist_type;
                        delete modifiedParams.dist_mu;
                        delete modifiedParams.dist_sigma;
                        modifiedParams.demand_dist = demandDist;
                        params = modifiedParams;
                    }

                    let message = `${template.name}ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚${toolName}é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚\n\n`;

                    // Add parameters in both readable format and JSON format for better LLM parsing
                    message += `ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:\n`;
                    Object.entries(params).forEach(([key, value]) => {
                        const field = template.fields.find(f => f.name === key);
                        if (field || key === 'demand_dist') {
                            if (Array.isArray(value)) {
                                message += `- ${key}: [${value.join(', ')}]\n`;
                            } else if (typeof value === 'object' && value !== null) {
                                message += `- ${key}: ${JSON.stringify(value)}\n`;
                            } else if (typeof value === 'number') {
                                message += `- ${key}: ${value}\n`;
                            } else {
                                message += `- ${key}: "${value}"\n`;
                            }
                        }
                    });

                    // Add JSON format for more reliable parsing
                    message += `\nJSONå½¢å¼:\n\`\`\`json\n${JSON.stringify(params, null, 2)}\n\`\`\`\n`;

                    // Add result request
                    message += `\né‡è¦: ä¸Šè¨˜ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å«ã‚ã¦${toolName}é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ãã ã•ã„ã€‚å®Ÿè¡Œå¾Œã€çµæœã‚’æ—¥æœ¬èªã§åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚`;

                    return message;
                },

                // Quick Form Methods
                openQuickForm(type) {
                    // Map quick form types to function IDs
                    const mapping = {
                        'eoq': 'calculate_eoq_incremental',
                        'demand_forecast': 'forecast_demand',
                        'safety_stock': 'calculate_safety_stock'
                    };

                    const functionId = mapping[type];
                    if (!functionId) return;

                    // Find the category and function
                    for (const category of this.functionCategories) {
                        const func = category.functions.find(f => f.id === functionId);
                        if (func) {
                            this.guidedForm = {
                                step: 3,
                                selectedCategory: category,
                                selectedFunction: func,
                                parameters: {}
                            };
                            this.showGuidedModal = true;
                            this.$nextTick(() => {
                                this.renderDynamicForm(functionId);
                            });
                            return;
                        }
                    }
                },

                // Auto-Detection Methods
                async detectToolAndExtractParams(userMessage) {
                    this.isLoading = true;
                    this.pendingUserMessage = userMessage;

                    try {
                        const token = localStorage.getItem('token');

                        // Step 1: Detect tool
                        const detectResponse = await fetch('/api/detect_tool', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ user_text: userMessage })
                        });

                        if (!detectResponse.ok) {
                            throw new Error('Tool detection failed');
                        }

                        const detectResult = await detectResponse.json();

                        // Extract the recommended tool from the detected_tools array
                        const recommendedToolName = detectResult.recommended_tool;
                        const recommendedTool = detectResult.detected_tools.find(
                            tool => tool.tool_name === recommendedToolName
                        );

                        this.detectedTool = recommendedTool || detectResult.detected_tools[0];

                        // Step 2: Extract parameters with detected tool
                        const extractResponse = await fetch('/api/extract_parameters', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                user_text: userMessage,
                                tool_name: this.detectedTool.tool_name
                            })
                        });

                        if (!extractResponse.ok) {
                            throw new Error('Parameter extraction failed');
                        }

                        const extractResult = await extractResponse.json();

                        // Backend returns either 'success: true' or 'status: success'
                        if (extractResult.success || extractResult.status === 'success') {
                            this.extractedParameters = extractResult.parameters || extractResult.extracted_params;
                            this.extractionError = null;
                        } else {
                            this.extractionError = extractResult.message || 'ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ';
                            this.extractedParameters = null;
                        }

                        // Show the confirmation modal
                        this.showParameterConfirmModal = true;

                    } catch (error) {
                        console.error('Error in auto-detection:', error);
                        this.extractionError = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
                        this.detectedTool = null;
                        this.extractedParameters = null;
                        this.showParameterConfirmModal = true;
                    } finally {
                        this.isLoading = false;
                    }
                },

                closeParameterConfirmModal() {
                    this.showParameterConfirmModal = false;
                    this.detectedTool = null;
                    this.extractedParameters = null;
                    this.extractionError = null;
                    this.pendingUserMessage = '';
                },

                async confirmAndExecute() {
                    // Close the modal
                    this.showParameterConfirmModal = false;

                    // Build the message with confirmed parameters
                    const toolName = this.detectedTool?.tool_name;
                    const params = this.extractedParameters;
                    const originalMessage = this.pendingUserMessage;

                    // Create a structured message that includes both the original request and extracted parameters
                    let message = `${originalMessage}\n\n--- è‡ªå‹•æ¤œå‡ºã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ---\n`;
                    message += `ãƒ„ãƒ¼ãƒ«: ${toolName}\n`;
                    message += `ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:\n`;

                    // Format parameters
                    Object.entries(params).forEach(([key, value]) => {
                        if (Array.isArray(value)) {
                            message += `- ${key}: [${value.join(', ')}]\n`;
                        } else if (typeof value === 'object' && value !== null) {
                            message += `- ${key}: ${JSON.stringify(value)}\n`;
                        } else {
                            message += `- ${key}: ${value}\n`;
                        }
                    });

                    message += `\nJSONå½¢å¼:\n\`\`\`json\n${JSON.stringify(params, null, 2)}\n\`\`\`\n`;
                    message += `\né‡è¦: ${toolName}é–¢æ•°ã‚’ä¸Šè¨˜ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å‘¼ã³å‡ºã—ã¦ãã ã•ã„ã€‚`;

                    // Clear the modal state
                    this.detectedTool = null;
                    this.extractedParameters = null;
                    this.extractionError = null;
                    this.pendingUserMessage = '';

                    // Add user message and execute
                    this.messages.push({
                        role: 'user',
                        content: message
                    });

                    this.isLoading = true;
                    this.scrollToBottom();

                    try {
                        const token = localStorage.getItem('token');

                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                messages: this.messages,
                                model: this.modelName
                            })
                        });

                        if (!response.ok) {
                            throw new Error('API request failed');
                        }

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let assistantMessage = '';

                        // Add assistant message placeholder
                        this.messages.push({
                            role: 'assistant',
                            content: ''
                        });

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    const data = line.slice(6);
                                    if (data === '[DONE]') break;

                                    try {
                                        const parsed = JSON.parse(data);
                                        if (parsed.content) {
                                            assistantMessage += parsed.content;
                                            this.messages[this.messages.length - 1].content = assistantMessage;
                                            this.scrollToBottom();
                                        } else if (parsed.function_call) {
                                            // Function callçµæœã‚’è¡¨ç¤º
                                            const funcName = parsed.function_call.name;
                                            const funcResult = parsed.function_call.result;

                                            let funcDisplay = `\n\nğŸ”§ **${funcName}ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ**\n\n`;

                                            // Check if result contains visualization URL or ID
                                            if (funcResult.visualization_url) {
                                                const vizUrl = funcResult.visualization_url;
                                                const message = funcResult.message || 'å¯è¦–åŒ–çµæœã‚’è¡¨ç¤º';
                                                funcDisplay += `ğŸ“Š ${message}\nğŸ”— [å¯è¦–åŒ–ã‚’é–‹ã](${vizUrl})\n\n`;
                                            } else if (funcResult.visualization_id) {
                                                const vizId = funcResult.visualization_id;
                                                const vizUrl = `/api/visualization/${vizId}`;
                                                const message = funcResult.message || 'å¯è¦–åŒ–çµæœã‚’è¡¨ç¤º';
                                                funcDisplay += `ğŸ“Š ${message}\nğŸ”— [å¯è¦–åŒ–ã‚’é–‹ã](${vizUrl})\n\n`;
                                            }

                                            // Display key results if available
                                            if (funcResult.status === 'success') {
                                                funcDisplay += `âœ… **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æˆåŠŸ\n\n`;

                                                // Display important metrics
                                                if (funcResult.message) {
                                                    funcDisplay += `ğŸ“ **çµæœ**: ${funcResult.message}\n\n`;
                                                }

                                                // Extract key metrics to display
                                                const keyMetrics = [];

                                                // EOQ results
                                                if (funcResult.optimal_order_quantity !== undefined) keyMetrics.push(`ğŸ“¦ **æœ€é©ç™ºæ³¨é‡**: ${funcResult.optimal_order_quantity.toFixed(2)} units`);
                                                if (funcResult.total_cost !== undefined) keyMetrics.push(`ğŸ’° **ç·ã‚³ã‚¹ãƒˆ**: ${funcResult.total_cost.toFixed(2)} å††/å¹´`);
                                                if (funcResult.ordering_cost !== undefined) keyMetrics.push(`ğŸ“ ç™ºæ³¨ã‚³ã‚¹ãƒˆ: ${funcResult.ordering_cost.toFixed(2)} å††/å¹´`);
                                                if (funcResult.holding_cost !== undefined) keyMetrics.push(`ğŸ“¦ åœ¨åº«ä¿ç®¡ã‚³ã‚¹ãƒˆ: ${funcResult.holding_cost.toFixed(2)} å††/å¹´`);
                                                if (funcResult.purchase_cost !== undefined) keyMetrics.push(`ğŸ’µ è³¼å…¥ã‚³ã‚¹ãƒˆ: ${funcResult.purchase_cost.toFixed(2)} å††/å¹´`);

                                                // Optimization results
                                                if (funcResult.best_cost !== undefined) keyMetrics.push(`ğŸ’° **ç·ã‚³ã‚¹ãƒˆ**: ${funcResult.best_cost.toFixed(2)}`);
                                                if (funcResult.average_cost !== undefined) keyMetrics.push(`ğŸ“Š å¹³å‡ã‚³ã‚¹ãƒˆ: ${funcResult.average_cost.toFixed(2)}`);
                                                if (funcResult.optimal_Q !== undefined) keyMetrics.push(`ğŸ“¦ **æœ€é©ç™ºæ³¨é‡**: ${funcResult.optimal_Q.toFixed(2)}`);
                                                if (funcResult.iterations !== undefined) keyMetrics.push(`ğŸ”„ åå¾©å›æ•°: ${funcResult.iterations}`);

                                                // Forecast results
                                                if (funcResult.forecast && Array.isArray(funcResult.forecast)) {
                                                    const forecastSummary = funcResult.forecast.slice(0, 3).map(v => v.toFixed(1)).join(', ');
                                                    keyMetrics.push(`ğŸ“ˆ äºˆæ¸¬å€¤: [${forecastSummary}, ...]`);
                                                }

                                                // Distribution fitting results
                                                if (funcResult.best_distribution) {
                                                    keyMetrics.push(`ğŸ“Š **æœ€é©åˆ†å¸ƒ**: ${funcResult.best_distribution}`);
                                                }

                                                if (keyMetrics.length > 0) {
                                                    funcDisplay += `**ä¸»ãªçµæœ**:\n${keyMetrics.map(m => `${m}`).join('\n')}\n\n`;
                                                }
                                            } else if (funcResult.status === 'error') {
                                                funcDisplay += `âŒ **ã‚¨ãƒ©ãƒ¼**: ${funcResult.message}\n\n`;
                                            }

                                            // Add collapsible detailed JSON
                                            const detailsId = `json-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                                            funcDisplay += `<details class="json-collapsible" id="${detailsId}">
                                                <summary class="json-collapsible-header">
                                                    <span>ğŸ“‹ è©³ç´°ãªçµæœã‚’è¡¨ç¤º</span>
                                                    <span class="json-toggle-icon">â–¼</span>
                                                </summary>
                                                <div class="json-collapsible-content">
\`\`\`json
${JSON.stringify(funcResult, null, 2)}
\`\`\`
                                                </div>
                                            </details>\n\n`;

                                            assistantMessage += funcDisplay;
                                            this.messages[this.messages.length - 1].content = assistantMessage;
                                            this.scrollToBottom();
                                        } else if (parsed.error) {
                                            this.messages[this.messages.length - 1].content = `ã‚¨ãƒ©ãƒ¼: ${parsed.error}`;
                                        }
                                    } catch (e) {
                                        // Ignore parse errors
                                    }
                                }
                            }
                        }

                        // Save to localStorage
                        localStorage.setItem('chatMessages', JSON.stringify(this.messages));

                    } catch (error) {
                        console.error('Error:', error);
                        this.messages.push({
                            role: 'assistant',
                            content: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
                        });
                    } finally {
                        this.isLoading = false;
                        this.scrollToBottom();
                    }
                },

                formatParamValue(value) {
                    if (Array.isArray(value)) {
                        return `[${value.join(', ')}]`;
                    } else if (typeof value === 'object' && value !== null) {
                        return JSON.stringify(value, null, 2);
                    } else if (typeof value === 'number') {
                        return value.toFixed(2);
                    } else {
                        return String(value);
                    }
                }
            }
        }
    </script>
</body>
</html>
